# Dockerfile para Apache Kafka
FROM confluentinc/cp-kafka:7.4.0

# Definir variáveis de ambiente
ENV KAFKA_BROKER_ID=1
ENV KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
ENV KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
ENV KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT
ENV KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
ENV KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
ENV KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
ENV KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
ENV KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
ENV KAFKA_JMX_PORT=9101
ENV KAFKA_JMX_HOSTNAME=localhost
ENV KAFKA_CONFLUENT_SCHEMA_REGISTRY_URL=http://schema-registry:8081
ENV KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
ENV KAFKA_DELETE_TOPIC_ENABLE=true

# Configurações de log e retenção
ENV KAFKA_LOG_RETENTION_HOURS=168
ENV KAFKA_LOG_SEGMENT_BYTES=1073741824
ENV KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS=300000

# Configurações de performance
ENV KAFKA_NUM_NETWORK_THREADS=8
ENV KAFKA_NUM_IO_THREADS=8
ENV KAFKA_SOCKET_SEND_BUFFER_BYTES=102400
ENV KAFKA_SOCKET_RECEIVE_BUFFER_BYTES=102400
ENV KAFKA_SOCKET_REQUEST_MAX_BYTES=104857600

# Criar diretório para logs
USER root
RUN mkdir -p /var/lib/kafka/data && \
    chown -R appuser:appuser /var/lib/kafka/data

USER appuser

# Expor portas
EXPOSE 9092 9101

# Comando de inicialização
CMD ["kafka-server-start", "/etc/kafka/server.properties"]